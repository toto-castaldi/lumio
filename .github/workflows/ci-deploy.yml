name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ============================================
  # CI Jobs - Run on all pushes and PRs
  # ============================================

  lint-and-typecheck:
    runs-on: ubuntu-latest
    # Skip if commit message starts with "docs:" or "docs("
    if: ${{ !startsWith(github.event.head_commit.message, 'docs:') && !startsWith(github.event.head_commit.message, 'docs(') }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build:packages

      - name: Typecheck
        run: pnpm typecheck

  # ============================================
  # Release - Auto version bump on main
  # ============================================

  release:
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      released: ${{ steps.release.outputs.released }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for releasable commits
        id: check
        run: |
          # Check if any tags exist
          if ! git describe --tags --abbrev=0 2>/dev/null; then
            echo "No tags found - will create first release"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "first_release=true" >> $GITHUB_OUTPUT
          else
            LAST_TAG=$(git describe --tags --abbrev=0)
            echo "Last tag: $LAST_TAG"

            # Count feat/fix commits since last tag
            FEAT_COUNT=$(git log ${LAST_TAG}..HEAD --oneline | grep -E "^[a-f0-9]+ feat" | wc -l || echo "0")
            FIX_COUNT=$(git log ${LAST_TAG}..HEAD --oneline | grep -E "^[a-f0-9]+ fix" | wc -l || echo "0")

            echo "Commits since $LAST_TAG: feat=$FEAT_COUNT, fix=$FIX_COUNT"

            if [ "$FEAT_COUNT" -gt 0 ] || [ "$FIX_COUNT" -gt 0 ]; then
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "first_release=false" >> $GITHUB_OUTPUT
            else
              echo "No releasable commits (feat/fix) since $LAST_TAG"
              echo "should_release=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run release
        id: release
        if: steps.check.outputs.should_release == 'true'
        run: |
          if [ "${{ steps.check.outputs.first_release }}" == "true" ]; then
            echo "Creating first release..."
            pnpm release -- --first-release
          else
            echo "Creating release..."
            pnpm release
          fi
          echo "released=true" >> $GITHUB_OUTPUT

      - name: Extract version
        id: version
        run: |
          VERSION=$(grep -oP 'VERSION = "\K[^"]+' packages/shared/src/version.ts)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Push release commit
        if: steps.release.outputs.released == 'true'
        run: git push origin main

      - name: Push release tag
        if: steps.release.outputs.released == 'true'
        run: git push origin --tags

  build-web:
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build:packages

      - name: Build web app
        run: pnpm build:web
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'http://localhost:54321' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || 'placeholder' }}
          BUILD_NUMBER: ${{ github.run_number }}
          COMMIT_SHA: ${{ github.sha }}
          BUILD_DATE: ${{ github.event.head_commit.timestamp }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: apps/web/dist

  # ============================================
  # Deploy Jobs - Only on push to main
  # ============================================

  deploy-web:
    runs-on: ubuntu-latest
    needs: [build-web, release]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main  # Get latest including release commit

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build:packages

      - name: Build web app
        run: pnpm build:web
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          BUILD_NUMBER: ${{ github.run_number }}
          COMMIT_SHA: ${{ github.sha }}
          BUILD_DATE: ${{ github.event.head_commit.timestamp }}

      - name: Deploy to DigitalOcean
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          source: 'apps/web/dist/*'
          target: '/var/www/lumio'
          strip_components: 3

      - name: Reload Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: sudo systemctl reload nginx

  deploy-migrations:
    runs-on: ubuntu-latest
    needs: release
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      # Backup database before migrations (optional, requires SUPABASE_DB_PASSWORD secret)
      - name: Backup database
        if: ${{ vars.ENABLE_DB_BACKUP == 'true' }}
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          supabase db dump --data-only -f "db_backup_${TIMESTAMP}.sql"
          echo "Backup created: db_backup_${TIMESTAMP}.sql"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: Upload backup artifact
        if: ${{ vars.ENABLE_DB_BACKUP == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ github.run_number }}
          path: db_backup_*.sql
          retention-days: 30

      - name: Run database migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  deploy-functions:
    runs-on: ubuntu-latest
    needs: [release, deploy-migrations]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main  # Get latest including release commit

      - name: Extract version info
        id: version
        run: |
          VERSION=$(grep -oP 'VERSION = "\K[^"]+' packages/shared/src/version.ts)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "git_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Build: ${{ github.run_number }}, SHA: ${GITHUB_SHA::7}"

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy Edge Functions
        run: |
          supabase functions deploy git-sync --no-verify-jwt --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          supabase functions deploy llm-proxy --no-verify-jwt --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          supabase functions deploy study-planner --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          supabase functions deploy version --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          LUMIO_VERSION: ${{ steps.version.outputs.version }}
          BUILD_NUMBER: ${{ steps.version.outputs.build_number }}
          GIT_SHA: ${{ steps.version.outputs.git_sha }}
          BUILD_DATE: ${{ steps.version.outputs.build_date }}

  build-mobile:
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build:packages

      - name: Build mobile PWA
        run: pnpm build:mobile
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'http://localhost:54321' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || 'placeholder' }}
          BUILD_NUMBER: ${{ github.run_number }}
          COMMIT_SHA: ${{ github.sha }}
          BUILD_DATE: ${{ github.event.head_commit.timestamp }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: mobile-dist
          path: apps/mobile/dist

  deploy-mobile:
    runs-on: ubuntu-latest
    needs: [build-mobile, release]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build:packages

      - name: Build mobile PWA
        run: pnpm build:mobile
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          BUILD_NUMBER: ${{ github.run_number }}
          COMMIT_SHA: ${{ github.sha }}
          BUILD_DATE: ${{ github.event.head_commit.timestamp }}

      - name: Deploy to DigitalOcean
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          source: 'apps/mobile/dist/*'
          target: '/var/www/lumio-mobile'
          strip_components: 3

      - name: Reload Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: sudo systemctl reload nginx
